<!-- src/app.html -->
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="%sveltekit.assets%/favicon.ico" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<link rel="icon" type="image/png" sizes="32x32" href="/AppImages/ios/32.png" />
		<link rel="icon" type="image/png" sizes="16x16" href="/AppImages/ios/16.png" />
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="apple-touch-icon" sizes="180x180" href="/AppImages/ios/180.png" />
		<link
			rel="icon"
			type="image/png"
			sizes="192x192"
			href="/AppImages/android/android-launchericon-192-192.png"
		/>
		<meta name="apple-mobile-web-app-title" content="BuildOS" />
		<link rel="manifest" href="/site.webmanifest" />

		<!-- Additional iOS icon sizes -->
		<link rel="apple-touch-icon" sizes="120x120" href="/AppImages/ios/120.png" />
		<link rel="apple-touch-icon" sizes="152x152" href="/AppImages/ios/152.png" />
		<link rel="apple-touch-icon" sizes="167x167" href="/AppImages/ios/167.png" />

		<!-- Android Chrome icons -->
		<link
			rel="icon"
			type="image/png"
			sizes="144x144"
			href="/AppImages/android/android-launchericon-144-144.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="512x512"
			href="/AppImages/android/android-launchericon-512-512.png"
		/>

		<!-- Enhanced iOS/Safari support -->
		<meta name="mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="format-detection" content="telephone=no" />

		<!-- Theme colors for light/dark mode -->
		<meta name="theme-color" content="#f9fafb" media="(prefers-color-scheme: light)" />
		<meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)" />

		<!-- Default theme color for iOS status bar -->
		<meta name="theme-color" content="#0f172a" />

		<!-- iOS splash screens (optional but recommended) -->
		<meta name="apple-touch-fullscreen" content="yes" />

		<!-- Global dev check -->
		<script>
			// Use build-time constant from Vite for consistency
			// Falls back to hostname check if not defined
			const isDev =
				typeof __DEV__ !== 'undefined'
					? __DEV__
					: window.location.hostname === 'localhost' ||
						window.location.hostname === '127.0.0.1' ||
						window.location.hostname.includes('local');
		</script>

		<!-- Conditional tracking scripts - only load in production after interaction -->
		<script>
			if (!isDev) {
				let analyticsLoaded = false;

				function loadAnalytics() {
					if (analyticsLoaded) return;
					analyticsLoaded = true;

					// Load Ahrefs Analytics
					const ahrefsScript = document.createElement('script');
					ahrefsScript.src = 'https://analytics.ahrefs.com/analytics.js';
					ahrefsScript.setAttribute('data-key', '56vE2mZ4skw/LvWdYhES/Q');
					ahrefsScript.async = true;
					ahrefsScript.defer = true;
					document.head.appendChild(ahrefsScript);

					// Load Microsoft Clarity
					(function (c, l, a, r, i, t, y) {
						c[a] =
							c[a] ||
							function () {
								(c[a].q = c[a].q || []).push(arguments);
							};
						t = l.createElement(r);
						t.async = 1;
						t.defer = 1;
						t.src = 'https://www.clarity.ms/tag/' + i;
						y = l.getElementsByTagName(r)[0];
						y.parentNode.insertBefore(t, y);
					})(window, document, 'clarity', 'script', 'sbiew2v5li');
				}

				// Load analytics on first user interaction or after 3 seconds
				const triggerEvents = ['click', 'scroll', 'keydown', 'touchstart'];
				const loadOnInteraction = () => {
					loadAnalytics();
					triggerEvents.forEach((event) => {
						window.removeEventListener(event, loadOnInteraction, { passive: true });
					});
				};

				triggerEvents.forEach((event) => {
					window.addEventListener(event, loadOnInteraction, { passive: true });
				});

				// Fallback: load after 3 seconds if no interaction
				setTimeout(loadAnalytics, 3000);
			}
		</script>

		%sveltekit.head%
	</head>

	<body>
		<div style="display: contents">%sveltekit.body%</div>

		<script>
			if (!isDev) {
				// Load Meta Pixel after the page has loaded to avoid blocking critical rendering
				function loadMetaPixel() {
					!(function (f, b, e, v, n, t, s) {
						if (f.fbq) return;
						n = f.fbq = function () {
							n.callMethod
								? n.callMethod.apply(n, arguments)
								: n.queue.push(arguments);
						};
						if (!f._fbq) f._fbq = n;
						n.push = n;
						n.loaded = !0;
						n.version = '2.0';
						n.queue = [];
						t = b.createElement(e);
						t.async = !0;
						t.src = v;
						s = b.getElementsByTagName(e)[0];
						s.parentNode.insertBefore(t, s);
					})(
						window,
						document,
						'script',
						'https://connect.facebook.net/en_US/fbevents.js'
					);

					fbq('init', '1295810581888875');
					fbq('track', 'PageView');
				}

				// Use requestIdleCallback for even better performance if available
				if ('requestIdleCallback' in window) {
					requestIdleCallback(loadMetaPixel);
				} else {
					// Fallback: load after page load
					if (document.readyState === 'loading') {
						// Create a named function for cleanup
						const handleLoad = function () {
							loadMetaPixel();
							// Clean up the event listener after use
							document.removeEventListener('DOMContentLoaded', handleLoad);
						};
						document.addEventListener('DOMContentLoaded', handleLoad);
					} else {
						// Page already loaded
						setTimeout(loadMetaPixel, 0);
					}
				}
			}
		</script>

		<!-- Fallback pixel for users with JavaScript disabled (only in production) -->
		<script>
			if (!isDev) {
				document.write(
					'<noscript><img height="1" width="1" style="display: none" src="https://www.facebook.com/tr?id=1295810581888875&ev=PageView&noscript=1" /></noscript>'
				);
			}
		</script>
	</body>
</html>
